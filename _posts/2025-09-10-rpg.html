---
layout: empty
title: "HTML5 RPG ê²Œì„"
excerpt: "ì¬ë°Œë‹¤. (Balanced by í–‰ì£¼.)"
date: 2025-09-10 18:03
image: "/asset/postasset/rpg.png"
---
<!doctype html>
<html lang="ko">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>ë˜ì „ íƒí—˜ í…ìŠ¤íŠ¸ RPG</title>
		<style>
			:root{
				--bg:#0f0f1a; /* ê¹Šì€ ë‚¨ìƒ‰ ë°°ê²½ */
				--panel:#19192a;
				--panel-2:#121223;
				--ink:#e6e6f0;
				--muted:#aab;
				--accent:#7bdcff; /* í•˜ëŠ˜ìƒ‰ */
				--accent-2:#ffcc66; /* ê¸ˆìƒ‰ */
				--danger:#ff6b6b;
				--ok:#7CFFB2;
			}
			html,body{
				height:100%;
				margin:0;
				background:var(--bg);
				color:var(--ink);
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
			}
			.wrap{
				max-width:1100px;
				margin: 0 auto;
				padding: 16px;
				display:grid;
				grid-template-columns: minmax(280px, 520px) 1fr;
				grid-gap: 16px;
			}
			.card{
				background: linear-gradient(180deg, var(--panel), var(--panel-2));
				border:1px solid #2b2b45;
				border-radius:12px;
				box-shadow: 0 10px 24px rgba(0,0,0,.35);
				padding: 12px 12px 14px;
			}
			.title{
				font-weight:700;
				letter-spacing:.2px;
				margin: 0 0 8px;
			}
			#screen-wrap{
				display:flex;gap:12px;align-items:flex-start;justify-content:center;flex-direction:column;position:relative;
			}
			#screen{
				width: 480px; /* CSS í”½ì…€ í¬ê¸° */
				height: 360px;
				image-rendering: -webkit-optimize-contrast; /* Edge í˜¸í™˜ */
				image-rendering: pixelated;
				border-radius:10px;
				border:2px solid #2e2e4d;
				background:#07070f;
				display:block;
			}
			.hud{
				display:flex;flex-wrap:wrap;gap:8px 16px;align-items:center;justify-content:space-between;
				font-size:14px;color:var(--muted);
				position: relative;
			}
			.stat{color:var(--ink)}
			.stat-group{display:flex;align-items:center;gap:8px}
			.hpbar{position:relative;height:14px;background:#2a2a3f;border-radius:8px;overflow:hidden;min-width:180px;border:1px solid #33344f}
			.hpbar > i{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#ff8b8b,#ff5454);box-shadow:inset 0 0 6px rgba(0,0,0,.4);width:0;transition:width .2s ease}
			.xpbar{position:relative;height:12px;background:#23233a;border-radius:8px;overflow:hidden;min-width:180px;border:1px solid #2e3053}
			.xpbar > i{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#6ce3ff,#5f9bff);width:0;transition:width .25s ease}
			.bar-label{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:12px;color:#eef;mix-blend-mode:screen;pointer-events:none;text-shadow:0 1px 0 rgba(0,0,0,.6)}
			.hpbar.pulse{animation: hpPulse .6s ease}
			@keyframes hpPulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,.5)}100%{box-shadow:0 0 0 8px rgba(255,107,107,0)}}
			.flex-break{flex:1 1 100%}
			.hud-wide{min-width:240px}
			.spacer{flex:1}

			#log{height:260px;overflow:auto;background:#101022;border:1px solid #2b2b45;border-radius:10px;padding:10px;font-size:14px;line-height:1.5}
			#log b{color:var(--accent)}
			#log .bad{color:var(--danger)}
			#log .good{color:var(--ok)}
			#log .gold{color:var(--accent-2)}

			.choices{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
			button.btn{
				appearance:none;border:1px solid #344; background:#1a1a2e; color:var(--ink);
				border-radius:10px; padding:10px 12px; cursor:pointer; text-align:left; font-size:15px;
				transition: scale .5s ease, box-shadow .5s;
			}
			button.btn:hover{scale: 1.05;box-shadow: 0 0 10px -2px rgba(255,255,255,.2)}
			button.btn:active{transform:translateY(0)}
			button.primary{border-color:#2c6f88; background:#113449}
			button.warn{border-color:#7a2a2a; background:#2a1418}
			button.green{border-color:#2a7a31; background:#142a1a}

			.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
			.toolbar > *{flex: none}
			.pill{padding:6px 10px;border-radius:20px;border:1px solid #2c2c44;background:#141428;color:#cdd;cursor: pointer;}
			.pill:hover{background:#171735}
			.file{display:none}

			.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
			/* í†µê³„ ëª¨ë‹¬ */
			.modal-overlay{position:fixed;inset:0;background:rgba(0,0,20,.6);display:none;align-items:center;justify-content:center;z-index:1000}
			.modal-overlay.open{display:flex}
			.modal{background:linear-gradient(180deg, var(--panel), var(--panel-2));border:1px solid #2b2b45;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.45);width:min(720px,92vw);max-height:85vh;overflow:auto}
			.modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #2b2b45}
			.modal-title{margin:0;font-size:18px}
			.modal-body{padding:12px 14px}
			.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
			.stats-card{border:1px solid #2b2b45;border-radius:10px;background:#121223;padding:10px}
			.stats-card h4{margin:0 0 6px;font-size:14px;color:var(--muted)}
			.stats-list{margin:0;padding-left:16px}
			.close-btn{appearance:none;border:1px solid #3a3a54;background:#13132a;color:#ccd;border-radius:8px;padding:6px 10px;cursor:pointer}
			.close-btn:hover{background:#171735}
			.quest-line{font-size:12px;color:var(--muted)}
			/* ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ì´ëª¨ì§€ ë²„íŠ¼ */
			button.btn.item-btn{display:flex;align-items:center;gap:8px}
			.item-emoji{font-size:18px;line-height:1}
			.item-main{display:flex;align-items:center;gap:6px}
			.item-badge{margin-left:auto;background:#1d2138;border:1px solid #2d3155;color:#cfe;padding:2px 6px;border-radius:999px;font-size:12px}
			button.btn.item-btn:hover .item-emoji{transform:translateY(-1px)}
			button.btn.item-btn:active .item-emoji{transform:translateY(0)}
			/* ë– ì˜¤ë¥´ëŠ” ìˆ˜ì¹˜ í‘œì‹œ */
			.float-pop{position:absolute;pointer-events:none;font-weight:700}
			.float-pop.heal{color:var(--ok)}
			.float-pop.buff{color:var(--accent-2)}
			.float-pop.dmg{color:var(--danger)}
			@keyframes riseFade{0%{opacity:0;transform:translate(-50%,-2px)}10%{opacity:1}100%{opacity:0;transform:translate(-50%,-28px)}}
			.float-pop{left:0;top:0;opacity:0;animation:riseFade .9s ease forwards;text-shadow:0 1px 0 #000}
			/* ë ˆì´ì•„ì›ƒ */
			.fullrow{grid-column:1 / -1}
			@media (max-width: 940px){
				.wrap{grid-template-columns: 1fr}
				#screen{width:100%;height:auto;aspect-ratio: 4 / 3}
			}
			.kbd{display:inline-block; border:1px solid #3a3a54; background:#13132a; padding:0 6px; border-radius:6px; font-size:12px; color:#ccd}
		</style>
	</head>
	<body>
		<div class="wrap">
			<section class="card" id="screen-wrap">
				<h2 class="title">ë˜ì „ íƒí—˜ í…ìŠ¤íŠ¸ RPG</h2>
				<canvas id="screen" width="160" height="120" aria-label="í”½ì…€ ë˜ì „ ì¥ë©´"></canvas>
				<div class="hud" id="hud">
					<div class="stat-group">
					    <span aria-hidden="true">ğŸ§¡</span>
						<span id="hpbar" class="hpbar" role="progressbar" aria-label="ì²´ë ¥" aria-valuemin="0" aria-valuemax="30" aria-valuenow="30">
							<i id="hpfill"></i>
							<span class="bar-label" id="hpLabel">30/30</span>
						</span>
					</div>
					<div class="stat-group"><span id="atkWrap">ğŸ—¡ <b id="atk">5</b></span> Â· <span id="defWrap">ğŸ›¡ <b id="def">2</b></span> Â· ğŸ’µ <b class="gold" id="gold">0</b></div>
					<div class="flex-break"></div>
					<div class="stat-group hud-wide">
                        <span class="stat">Lv <span id="lv">1</span></span>
						<span id="xpbar" class="xpbar" role="progressbar" aria-label="ê²½í—˜ì¹˜" aria-valuemin="0" aria-valuemax="10" aria-valuenow="0">
							<i id="xpfill"></i>
							<span class="bar-label" id="xpLabel">0/10</span>
						</span>
					</div>
					<div class="flex-break"></div>
					<div id="questLine" class="stat-group quest-line" aria-live="polite"></div>
				</div>
				<div class="toolbar">
					<button class="pill" id="newGameBtn" title="ìƒˆ ê²Œì„ ì‹œì‘ (R)">ìƒˆ ê²Œì„</button>
					<button class="pill" id="saveBtn" title="í˜„ì¬ ì§„í–‰ ì €ì¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (S)">ì €ì¥(ë‹¤ìš´ë¡œë“œ)</button>
					<button class="pill" id="loadBtn" title="ì €ì¥ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (L)">ë¶ˆëŸ¬ì˜¤ê¸°</button>
					<button class="pill" id="statsBtn" title="í†µê³„ ë³´ê¸° (T)">í†µê³„</button>
					<input class="file" id="loadInput" type="file" accept=".rpg,application/json,.json" />
					<span class="spacer"></span>
					<span class="muted">ìˆ«ìí‚¤ <span class="kbd">1-9</span> ë¡œ ì„ íƒ Â· ì´ë™ <span class="kbd">â†</span><span class="kbd">â†‘</span><span class="kbd">â†’</span></span>
				</div>
			</section>

			<section class="card">
				<h3 class="title">ê¸°ë¡</h3>
				<div id="log" role="log" aria-live="polite"></div>
				<div class="choices" id="choices" aria-label="ì„ íƒì§€"></div>
			</section>

			<section class="card fullrow">
				<h3 class="title">ì¸ë²¤í† ë¦¬</h3>
				<div id="inventory" class="grid" aria-label="ì¸ë²¤í† ë¦¬"></div>
			</section>
		</div>

		<!-- í†µê³„ ëª¨ë‹¬ -->
		<div id="statsModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-label="í”Œë ˆì´ í†µê³„">
			<div class="modal">
				<div class="modal-header">
					<h3 class="modal-title">í”Œë ˆì´ í†µê³„</h3>
					<button class="close-btn" id="statsCloseBtn">ë‹«ê¸°</button>
				</div>
				<div class="modal-body">
					<div class="stats-grid">
						<div class="stats-card">
							<h4>ì „íˆ¬</h4>
							<ul class="stats-list">
								<li>ì²˜ì¹˜í•œ ëª¬ìŠ¤í„°: <b id="st_monsters">0</b></li>
								<li>ì²˜ì¹˜í•œ ë³´ìŠ¤: <b id="st_bosses">0</b></li>
								<li>ì‚¬ë§ íšŸìˆ˜: <b id="st_deaths">0</b></li>
							</ul>
						</div>
						<div class="stats-card">
							<h4>íƒí—˜</h4>
							<ul class="stats-list">
								<li>ê±¸ìŒ ìˆ˜: <b id="st_steps">0</b></li>
								<li>ìµœëŒ€ ë„ë‹¬ ì¸µ: <b id="st_maxfloor">1</b></li>
								<li>ì—°ê¸ˆ ì•„ì´í…œ ì‚¬ìš©(ë¬¼ì•½): <b id="st_potions">0</b></li>
								<li>í­íƒ„ ì‚¬ìš©: <b id="st_bombs">0</b></li>
							</ul>
						</div>
						<div class="stats-card">
							<h4>ì¬í™”</h4>
							<ul class="stats-list">
								<li>íšë“í•œ ê³¨ë“œ: <b id="st_goldEarned">0</b></li>
								<li>ì†Œë¹„í•œ ê³¨ë“œ: <b id="st_goldSpent">0</b></li>
							</ul>
						</div>
						<div class="stats-card">
							<h4>ì´ë²¤íŠ¸</h4>
							<ul class="stats-list">
								<li>ì—´ì–´ë³¸ ìƒì: <b id="st_chests">0</b></li>
								<li>í•¨ì • ìƒì: <b id="st_chestTrap">0</b></li>
								<li>ë¯¸ë¯¹ ì¡°ìš°: <b id="st_mimic">0</b></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			// ===== ìœ í‹¸ & RNG =====
			const clamp = (v, a, b)=> Math.max(a, Math.min(b, v));
			const rndInt = (min, max)=> Math.floor(rand() * (max - min + 1)) + min;
			const choice = (arr)=> arr.length? arr[Math.floor(rand()*arr.length)] : undefined;
			const nowStr = ()=>{
				const d=new Date();
				const z=n=>String(n).padStart(2,'0');
				return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}-${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}`;
			}

			// ===== ë°¸ëŸ°ìŠ¤ ìƒìˆ˜ =====
			const BAL = {
				monster: {
					perLevel: 0.16,               // ëª¬ìŠ¤í„° ë ˆë²¨ë‹¹ ëŠ¥ë ¥ ì¦ê°€ìœ¨(ì„ í˜•) (ì™„í™”)
					defMitigationVsPlayer: 0.95,   // ì ì´ í”Œë ˆì´ì–´ë¥¼ ë•Œë¦´ ë•Œ í”Œë ˆì´ì–´ ë°©ì–´ ì ìš© ë¹„ìœ¨ (í”Œë ˆì´ì–´ ë°©ì–´ ë” ì˜ ë¨¹íˆê²Œ)
					defMitigationVsMonster: 1.00   // í”Œë ˆì´ì–´ê°€ ì ì„ ë•Œë¦´ ë•Œ ì  ë°©ì–´ ì ìš© ë¹„ìœ¨
				},
				boss: {
					levelOffset: 0,               // ë³´ìŠ¤ëŠ” í”Œë ˆì´ì–´ ì²´ê° ì™„í™” ìœ„í•´ -1
					hpMul: 0.92,                   // ì²´ë ¥ í•˜í–¥
					atkMul: 0.90,                  // ê³µê²©ë ¥ í•˜í–¥
					defMul: 0.90,                  // ë°©ì–´ë ¥ í•˜í–¥
					rewardMul: 1.15
				},
				player: {
					hpGainMin: 4,
					hpGainMax: 6,
					atkPerLevelMin: 1,
					atkPerLevelMax: 2,
					defUpChance: 0.6,
					xpGrowth: 1.44                  // ì´ˆë°˜ ì„±ì¥ ì•½ê°„ ì™„í™”í•´ ë ˆë²¨ì—… ë” ìì£¼
				},
				combat: {
					critChance: 0.09,              // ì¹˜ëª…íƒ€ ì†Œí­ ìƒí–¥
					critMul: 2.4,                  // ë°°ìˆ˜ ì†Œí­ í•˜í–¥ìœ¼ë¡œ ì•ˆì •í™”
					pVarMin: -2,  // í”Œë ˆì´ì–´ ê³µê²© ë³€ë™ì¹˜ ì™„í™”
					pVarMax: 2,
					eVarMin: -2,  // ì  ê³µê²© ë³€ë™ì¹˜ ì™„í™”
					eVarMax: 2,
					guardReduction: 0.5
				},
				mods: {
					lifesteal: 0.10,
					bleed: 0.18,
					stun: 0.10,
					regenChance: 0.05,
					armorDodge: 0.14,
					thornsBase: 1,
					thornsPerFloor: 0.5
				},
				items: {
					potionBase: [10,14],
					potionPerFloor: 1.2,
					bombBase: [10,16],
					bombPerFloor: 1.0,
					weaponPerFloor: 0.45,
					armorPerFloor: 0.35
				},
				encounter: {
					bossChanceBase: 0.03,          // ë³´ìŠ¤ ì¡°ìš° ê¸°ë³¸ í™•ë¥  í•˜í–¥
					bossChancePerFloor: 0.006,      // ì¦ê°€ í­ ê°ì†Œ
					bossChancePerLevel: 0.003,
					bossChanceMax: 0.09             // ìƒí•œ í•˜í–¥
				}
			};

			// ===== ì•„ì´í…œ ë“±ê¸‰/í¬ê·€ë„ =====
			const ITEM_TIERS = [
				{key:'wood', label:'ë‚˜ë¬´', atkBase:1, defBase:1, weight:(f)=> f<4?60: f<8?25: f<12?10: 3},
				{key:'cobalt', label:'ì½”ë°œíŠ¸', atkBase:4, defBase:2, weight:(f)=> f<4?35: f<8?50: f<12?30: 12},
				{key:'iron', label:'ì² ', atkBase:2, defBase:4, weight:(f)=> f<4?5: f<8?20: f<12?45: 35},
				{key:'diamond', label:'ë‹¤ì´ì•„ëª¬ë“œ', atkBase:5, defBase:5, weight:(f)=> f<8?5: f<12?15: 50},
			];
			const RARITIES = [
				{key:'shoddy', label:'ì—‰ì„±í•œ', mul:0.75, weight:35},
				{key:'normal', label:'ì¼ë°˜', mul:1.0, weight:55},
				{key:'legendary', label:'ì „ì„¤', mul:1.35, weight:10},
			];

			function pickByWeight(items, weightFn){
				const weights = items.map(it=> typeof weightFn==='function'? weightFn(it) : (weightFn?weightFn: (it.weight||1)));
				const sum = weights.reduce((a,b)=>a+b,0) || 1;
				let r = rand()*sum;
				for(let i=0;i<items.length;i++){ r -= weights[i]; if(r<=0) return items[i]; }
				return items[items.length-1];
			}
			function pickTierByFloor(f){ return pickByWeight(ITEM_TIERS, (it)=> it.weight(f)); }
			function pickRarity(opts){
				// opts: {shop?:bool, legendaryBias?:number}
				const base = RARITIES.map(r=> ({...r}));
				if(opts?.shop){ base.find(r=>r.key==='legendary').weight = 6; base.find(r=>r.key==='shoddy').weight = 40; base.find(r=>r.key==='normal').weight = 54; }
				if(opts?.legendaryBias){ const lr = base.find(r=>r.key==='legendary'); lr.weight = Math.max(1, Math.round(lr.weight * opts.legendaryBias)); }
				return pickByWeight(base, (it)=> it.weight);
			}

			// ë¬´ê¸° íƒ€ì… ì •ì˜
			const WEAPON_TYPES = [
				{key:'sword', label:'ê²€', emoji:'âš”ï¸', desc:'ê· í˜•í˜•'},
				{key:'axe', label:'ë„ë¼', emoji:'ğŸª“', desc:'ë†’ì€ ì¹˜ëª… ë°°ìˆ˜'},
				{key:'spear', label:'ì°½', emoji:'ğŸ¹', desc:'ë°©ì–´ ì¼ë¶€ ê´€í†µ'},
				{key:'dagger', label:'ë‹¨ê²€', emoji:'ğŸ—¡ï¸', desc:'ì¹˜ëª… í™•ë¥ â†‘'},
				{key:'bow', label:'í™œ', emoji:'ğŸ¹', desc:'ë³€ë™ í”¼í•´, íšŒí”¼ ë¬´ì‹œ ì•½ê°„'},
				{key:'staff', label:'ì§€íŒ¡ì´', emoji:'ğŸª„', desc:'ë§ˆë ¥ ì¶”ê°€ í”¼í•´'}
			];

			function makeName(kind, tier, rarity, wtype){
				const base = kind==='weapon'? (wtype?.label||'ë¬´ê¸°') : 'ê°‘ì˜·';
				return `${rarity.label} ${tier.label} ${base}`;
			}

			function createWeapon(tier, rarity, f){
				const floor = f ?? game?.floor ?? 1;
				const t = tier ?? pickTierByFloor(floor);
				const r = rarity ?? pickRarity();
				const base = 1 + Math.floor((floor-1)*BAL.items.weaponPerFloor) + t.atkBase + rndInt(0,2);
				const atk = Math.max(1, Math.round(base * r.mul));
				// ë¬´ê¸° íƒ€ì… ì„ íƒ
				const wtype = choice(WEAPON_TYPES);
				let w = {id:uid(), name: makeName('weapon', t, r, wtype), kind:'weapon', atk, amount:1, tier:t.key, rarity:r.key, wtype: wtype.key};
				// í¬ê·€ë„ì— ë”°ë¥¸ ëª¨ë“œ ë¶€ì—¬
				if(r.key==='legendary'){
					w = maybeModWeapon(w, 0.95);
					// ì „ì„¤ì€ ì¶”ê°€ ëª¨ë“œ í™•ë¥ 
					if(rand()<0.5) w = maybeModWeapon(w, 1.0);
				}else{
					w = maybeModWeapon(w, r.key==='shoddy'? 0.1 : 0.25);
				}
				return w;
			}

			function createArmor(tier, rarity, f){
				const floor = f ?? game?.floor ?? 1;
				const t = tier ?? pickTierByFloor(floor);
				const r = rarity ?? pickRarity();
				const base = 1 + Math.floor((floor-1)*BAL.items.armorPerFloor) + t.defBase + rndInt(0,2);
				const def = Math.max(1, Math.round(base * r.mul));
				let a = {id:uid(), name: makeName('armor', t, r), kind:'armor', def, amount:1, tier:t.key, rarity:r.key};
				if(r.key==='legendary'){
					a = maybeModArmor(a, 0.95);
					if(rand()<0.5) a = maybeModArmor(a, 1.0);
				}else{
					a = maybeModArmor(a, r.key==='shoddy'? 0.1 : 0.25);
				}
				return a;
			}

			// ì™¸ë¶€ ìƒíƒœ ê¸°ë°˜ mulberry32 ìœ ì‚¬ PRNG (stateëŠ” game.rngState)
			function rand(){
				// 32-bit unsigned int â†’ [0,1)
				game.rngState = (game.rngState + 0x6D2B79F5) >>> 0;
				let t = game.rngState;
				t = Math.imul(t ^ (t >>> 15), t | 1);
				t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
				return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
			}

			function seeded(seed){ game.rngState = seed >>> 0; }

			// ===== ê²Œì„ ìƒíƒœ =====
			const V=1; // ì €ì¥ ë²„ì „
			let game = null;

			function basePlayer(){
				return {
					name: 'ëª¨í—˜ê°€',
					level: 1,
					xp: 0,
					xpToNext: 10,
					hp: 30,
					maxHp: 30,
					atk: 5,
					def: 2,
					gold: 30,
					weapon: null,
					armor: null,
					inventory: [], // {id,name,kind,amount,atk?,def?,heal?}
				};
			}

			// í”Œë ˆì´ í†µê³„ ê¸°ë³¸ê°’
			function baseStats(){
				return {
					monstersDefeated: 0,
					bossesDefeated: 0,
					deaths: 0,
					stepsTaken: 0,
					maxFloor: 1,
					potionsUsed: 0,
					bombsUsed: 0,
					goldEarned: 0,
					goldSpent: 0,
					chestsOpened: 0,
					chestsTrapped: 0,
					mimicsEncountered: 0,
				};
			}

			function newGame(seed){
				game = {
					version: V,
					rngState: (seed ?? (Date.now() ^ (Math.random()*1e9)|0)) >>> 0,
					floor: 1,
					steps: 0,
					state: 'explore', // explore | combat | loot | gameover
					message: 'ì¶•ì¶•í•œ ê³µê¸°ê°€ ê°ë„ëŠ” ë˜ì „ì— ë“¤ì–´ì„°ë‹¤.',
					player: basePlayer(),
					stats: baseStats(),
					quest: null,
					buffs: { blessing: 0 }, // í–‰ìš´ ì¶•ë³µ ìŠ¤íƒ
					skills: { powerStrike: {cd:0}, guardStance: {cd:0}, doubleSlash:{cd:0}, firstAid:{cd:0} },
					encounter: null,
					lastChoices: [],
				};
				log(`ìƒˆë¡œìš´ ëª¨í—˜ì´ ì‹œì‘ë˜ì—ˆë‹¤. (ì”¨ë“œ ${game.rngState})`);
				presentExplore();
				draw();
				syncHUD();
				ensureQuest();
				renderStats();
			}

			// ===== ë¡œê·¸ =====
			const logEl = document.getElementById('log');
			function log(html){
				const div = document.createElement('div');
				div.innerHTML = html;
				logEl.appendChild(div);
				logEl.scrollTop = logEl.scrollHeight;
			}
			function clearLog(){ logEl.innerHTML=''; }

			// ===== HUD/ì¸ë²¤í† ë¦¬ ë Œë” =====
			function syncHUD(){
				const p = game.player;
				document.getElementById('lv').textContent = p.level;
				// HP ë°” ë° ë¼ë²¨/ARIA ê°±ì‹ 
				const hpPct = clamp((p.hp / p.maxHp) * 100, 0, 100);
				document.getElementById('hpLabel').textContent = `${p.hp}/${p.maxHp}`;
				const hpbar = document.getElementById('hpbar');
				hpbar.setAttribute('aria-valuenow', String(p.hp));
				hpbar.setAttribute('aria-valuemax', String(p.maxHp));
				document.getElementById('hpfill').style.width = hpPct + '%';
				document.getElementById('atk').textContent = getAtk(p);
				document.getElementById('def').textContent = getDef(p);
				document.getElementById('gold').textContent = p.gold;
				// XP ë°” ë° ë¼ë²¨/ARIA ê°±ì‹ 
				document.getElementById('xpLabel').textContent = `${p.xp}/${p.xpToNext}`;
				const xpbar = document.getElementById('xpbar');
				xpbar.setAttribute('aria-valuenow', String(p.xp));
				xpbar.setAttribute('aria-valuemax', String(p.xpToNext));
				document.getElementById('xpfill').style.width = clamp((p.xp/p.xpToNext)*100,0,100) + '%';
				renderInventory();
				renderQuestLine();
			}

			// === í€˜ìŠ¤íŠ¸ ===
			function ensureQuest(){
				if(game.quest) return;
				const types=['slay','chest'];
				const t = choice(types);
				if(t==='slay'){
					const need = rndInt(2,3);
					game.quest = {kind:'slay', need, done:0, reward: {gold: 8 + game.floor*3}};
					log(`í€˜ìŠ¤íŠ¸ ìˆ˜ì£¼: ëª¬ìŠ¤í„° ${need}ë§ˆë¦¬ ì²˜ì¹˜ (ë³´ìƒ ${game.quest.reward.gold}G)`);
				}else{
					const need = rndInt(1,2);
					game.quest = {kind:'chest', need, done:0, reward: {bless: 1}};
					log(`í€˜ìŠ¤íŠ¸ ìˆ˜ì£¼: ë³´ë¬¼ìƒì ${need}ê°œ ì—´ê¸° (ë³´ìƒ ì¶•ë³µ +1)`);
				}
				renderQuestLine();
			}
			function renderQuestLine(){
				const qel=document.getElementById('questLine'); if(!qel) return;
				const q=game.quest; if(!q){ qel.textContent=''; return; }
				const text = q.kind==='slay' ? `í€˜ìŠ¤íŠ¸: ëª¬ìŠ¤í„° ì²˜ì¹˜ ${q.done}/${q.need}` : `í€˜ìŠ¤íŠ¸: ìƒì ì—´ê¸° ${q.done}/${q.need}`;
				qel.textContent = text + (game.buffs?.blessing?` Â· ì¶•ë³µ ${game.buffs.blessing}`:'');
			}
			function questProgress(kind){
				const q=game.quest; if(!q || q.kind!==kind) return;
							q.done++; renderQuestLine();
							if(q.done>=q.need){
					// ë³´ìƒ ìˆ˜ë ¹
					if(q.reward.gold){ game.player.gold += q.reward.gold; if(game.stats) game.stats.goldEarned += q.reward.gold; log(`<span class="gold">í€˜ìŠ¤íŠ¸ ë³´ìƒ +${q.reward.gold}G</span>`); }
					if(q.reward.bless){ game.buffs.blessing += q.reward.bless; log(`ì¶•ë³µì´ ê¹ƒë“¤ì—ˆë‹¤. (ìŠ¤íƒ ${game.buffs.blessing})`); }
								game.quest=null; ensureQuest(); renderQuestLine();
					syncHUD();
				}
			}

			function renderInventory(){
				const inv = document.getElementById('inventory');
				const p = game.player;
				const eqDiv = document.createElement('div');
				const eqWeapon = p.weapon? `âš”ï¸ ${p.weapon.name} <span class="item-badge">+${p.weapon.atk} ATK</span>` : 'âš”ï¸ ì—†ìŒ';
				const eqArmor = p.armor? `ğŸ›¡ï¸ ${p.armor.name} <span class="item-badge">+${p.armor.def} DEF</span>` : 'ğŸ›¡ï¸ ì—†ìŒ';
				eqDiv.innerHTML = `<div><b>ì¥ë¹„</b><br>${eqWeapon}<br>${eqArmor}</div>`;
				inv.innerHTML = '';
				inv.appendChild(eqDiv);

				const itemsDiv = document.createElement('div');
				itemsDiv.innerHTML = `<div><b>ì†Œì§€í’ˆ</b></div>`;
				p.inventory.forEach((it, idx)=>{
					const btn = document.createElement('button');
					btn.className='btn item-btn';
					const emoji = itemEmoji(it);
					const effect = itemEffectBadge(it);
					btn.innerHTML = `<span class="item-emoji" aria-hidden="true">${emoji}</span><span class="item-main">${it.name}${it.amount>1?` x${it.amount}`:''}</span><span class="item-badge">${effect}</span>`;
					btn.title = `${emoji} ${itemDesc(it)}`;
					btn.setAttribute('aria-label', `${it.name} ${itemDesc(it)}`);
					btn.onclick = ()=> useItem(idx);
					itemsDiv.appendChild(btn);
				});
				if(p.inventory.length===0){
					const small=document.createElement('div'); small.style.color='var(--muted)'; small.style.marginTop='4px'; small.textContent='ë¹„ì–´ ìˆìŒ'; itemsDiv.appendChild(small);
				}
				inv.appendChild(itemsDiv);
			}

			function itemEmoji(it){
				switch(it.kind){
					case 'potion': return 'ğŸ§ª';
					case 'bomb': return 'ğŸ’£';
					case 'weapon': {
						const wt = WEAPON_TYPES.find(w=>w.key===it.wtype);
						return wt?.emoji || 'âš”ï¸';
					}
					case 'armor': return 'ğŸ›¡ï¸';
					default: return 'ğŸ’';
				}
			}
			function itemEffectBadge(it){
				switch(it.kind){
					case 'potion': return `+${it.heal} HP`;
					case 'bomb': return `${it.dmg} DMG`;
					case 'weapon': {
						const wt = WEAPON_TYPES.find(w=>w.key===it.wtype);
						return `${wt?wt.label+' ':''}+${it.atk} ATK${it.mods?' Â· âœ¨':''}`;
					}
					case 'armor': return `+${it.def} DEF${it.mods?' Â· âœ¨':''}`;
					default: return '';
				}
			}

			// ===== ì „íˆ¬/ì´ë²¤íŠ¸ =====
			const monsters = [
				{name:'ìŠ¬ë¼ì„', ch:'S', color:'#6ce5ff', hp:12, atk:3, def:0, gold:[2,7], xp:1},
				{name:'ê³ ë¸”ë¦°', ch:'G', color:'#5cff7e', hp:16, atk:4, def:1, gold:[5,12], xp:4},
				{name:'í•´ê³¨', ch:'K', color:'#d7d7e6', hp:18, atk:5, def:2, gold:[6,15], xp:5},
				{name:'ì˜¤ìš°ê±°', ch:'O', color:'#b5743f', hp:26, atk:7, def:3, gold:[10,22], xp:9},
			];

			// ë³´ìŠ¤ ëª©ë¡
			const bosses = [
				{name:'ë¦¬ì¹˜', ch:'B', color:'#9b59b6', hp:60, atk:13, def:2, gold:[28,60], xp:26},
				{name:'ë¯¸ë¯¹', ch:'M', color:'#c27b39', hp:48, atk:7, def:8, gold:[30,100], xp:30},
				{name:'ë¯¸ë…¸íƒ€ìš°ë¡œìŠ¤', ch:'U', color:'#b84e3a', hp:90, atk:9, def:3, gold:[35,70], xp:30},
			];

			function scaleByFloor(base, floor){
				// (êµ¬) í•˜ìœ„í˜¸í™˜ìš©. ë‚´ë¶€ì—ì„  ëª¬ìŠ¤í„° ë ˆë²¨ ê¸°ë°˜ ìŠ¤ì¼€ì¼ ì‚¬ìš©.
				const lvl = game?.player?.level || 1;
				const f = 1 + (floor-1)*0.12 + Math.max(0,(lvl-1))*0.02; // ì™„ë§Œ ì¡°ì •
				return Math.round(base * f);
			}

			// ëª¬ìŠ¤í„° ë ˆë²¨ ì‚°ì •: ì¸µ + í”Œë ˆì´ì–´ ë ˆë²¨ì˜ 80% ë°˜ì˜
			function monsterLevelFor(playerLevel, floor){
				return Math.max(1, Math.floor(floor*2 + Math.max(0, (playerLevel-1)) * 0.6));
			}
			// ë ˆë²¨ ê¸°ë°˜ ìŠ¤ì¼€ì¼: ë ˆë²¨ë‹¹ +12%ë¡œ ì ì§„ ê°•í™”
			function scaleByMonLevel(base, monLevel){
				const mul = 1 + (Math.max(1, monLevel)-1) * BAL.monster.perLevel;
				return Math.round(base * mul);
			}

			function spawnMonster(){
				const proto = choice(monsters);
				const f = game.floor;
				const ml = monsterLevelFor(game.player.level, f);
				return {
					name: proto.name,
					ch: proto.ch,
					color: proto.color,
					hp: scaleByMonLevel(proto.hp, ml),
					maxHp: scaleByMonLevel(proto.hp, ml),
					atk: scaleByMonLevel(proto.atk, ml),
					def: Math.max(0, Math.round(scaleByMonLevel(proto.def, ml))),
					gold: rndInt(Math.floor(proto.gold[0]*f*0.5), Math.floor(proto.gold[1]*f*0.6)),
					xp: scaleByMonLevel(proto.xp, ml),
					level: ml,
				};
			}

			function spawnBoss(kind){
				const proto = kind ? bosses.find(b=>b.name.includes(kind)) : choice(bosses);
				const f = game.floor;
				const ml = monsterLevelFor(game.player.level, f) + BAL.boss.levelOffset;
				const hp = Math.round(scaleByMonLevel(proto.hp, ml) * BAL.boss.hpMul);
				const atk = Math.round(scaleByMonLevel(proto.atk, ml) * BAL.boss.atkMul);
				const def = Math.round(scaleByMonLevel(proto.def, ml) * BAL.boss.defMul);
				return {
					name: `ë³´ìŠ¤: ${proto.name}`,
					ch: proto.ch,
					color: proto.color,
					hp, maxHp: hp,
					atk, def,
					gold: rndInt(Math.floor(proto.gold[0]*f*0.75), Math.floor(proto.gold[1]*f*BAL.boss.rewardMul)),
					xp: Math.round(scaleByMonLevel(proto.xp, ml) * 1.15),
					boss: true,
					level: ml,
				};
			}

			function presentExplore(){
				game.state='explore';
				const opts = [
					{label:'ì•ìœ¼ë¡œ ê°„ë‹¤ (â†‘)', class:'primary', run: ()=> move('forward')},
					{label:'ì™¼ìª½ìœ¼ë¡œ ê°„ë‹¤ (â†)', run: ()=> move('left')},
					{label:'ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°„ë‹¤ (â†’)', run: ()=> move('right')},
					{label:'ì‰¬ì–´ê°„ë‹¤', run: ()=> rest() },
				];
				setChoices(opts);
			}

			function move(dir){
				game.steps++;
				if(game.stats){ game.stats.stepsTaken++; }
				const flavor = {
					forward:['ì•ìª½ìœ¼ë¡œ ê¸¸ì´ ì´ì–´ì§„ë‹¤.','ì¢ì€ ë³µë„ê°€ ê³„ì†ëœë‹¤.','ë¨¼ ê³³ì—ì„œ ë¬¼ë°©ìš¸ ë–¨ì–´ì§€ëŠ” ì†Œë¦¬ê°€ ë“¤ë¦°ë‹¤.'],
					left:['ì™¼í¸ ë²½ì— ì´ë¼ê°€ ê°€ë“í•˜ë‹¤.','ì™¼ìª½ìœ¼ë¡œ êµ½ì€ ê¸¸ì„ ì§€ë‚œë‹¤.','ë°”ë‹¥ì— ì˜¤ë˜ëœ ë°œìêµ­ì´ ë³´ì¸ë‹¤.'],
					right:['ì˜¤ë¥¸í¸ìœ¼ë¡œ ì°¬ë°”ëŒì´ ìŠ¤ì¹œë‹¤.','ì˜¤ë¥¸ìª½ í†µë¡œê°€ ì‚´ì§ ë„“ì–´ì§„ë‹¤.','ë¨¼ì§€ ì†ì—ì„œ ê¸ˆì† ëƒ„ìƒˆê°€ ë‚œë‹¤.'],
				};
				log(`${choice(flavor[dir])}`);
				// ë‚®ì€ í™•ë¥ ë¡œ ë³´ìŠ¤ ì¡°ìš° (ìƒìˆ˜ ê¸°ë°˜)
				const bossChance = Math.min(
					BAL.encounter.bossChanceBase
					+ game.floor*BAL.encounter.bossChancePerFloor
					+ Math.max(0,(game.player.level-1))*BAL.encounter.bossChancePerLevel,
					BAL.encounter.bossChanceMax
				);
				if(rand() < bossChance){
					log('ì–´ë‘  ì†ì—ì„œ ê°•ë ¥í•œ ê¸°ìš´ì´ ê°ëˆë‹¤...');
					startCombat(spawnBoss());
					return;
				}
				// ì´ë²¤íŠ¸ êµ´ë¦¼
				const r = rand();
				if(r < 0.45){
					// ëª¬ìŠ¤í„° ì¡°ìš°
					startCombat(spawnMonster());
				} else if(r < 0.56){
					// ì•„ì´í…œ íšë“
					const it = randomItem();
					addItem(it);
					log(`<span class="good">${it.name}</span> ì„(ë¥¼) ë°œê²¬í–ˆë‹¤.`);
					draw();
					presentExplore();
					syncHUD();
				} else if(r < 0.66){
					// í•¨ì •
					const dmg = rndInt(2, 6) + Math.floor(game.floor*0.7);
					hurtPlayer(dmg);
					log(`<span class="bad">í•¨ì •!</span> ${dmg} í”¼í•´ë¥¼ ì…ì—ˆë‹¤.`);
					if(checkGameOver()) return;
					draw();
					presentExplore();
					syncHUD();
				} else if(r < 0.74){
					// ìƒì  ì´ë²¤íŠ¸ (êµ¬ë§¤/íŒë§¤)
					shopEvent();
				} else if(r < 0.84){
					// ë³´ë¬¼ìƒì ì´ë²¤íŠ¸
					chestEvent();
				} else {
					// ì•„ë¬´ ì¼ ì—†ìŒ
					if(game.steps % 6 === 0){
						game.floor++;
						if(game.stats){ game.stats.maxFloor = Math.max(game.stats.maxFloor, game.floor); }
						log(`<b>ê³„ë‹¨</b>ì„ ë‚´ë ¤ê°€ <b>${game.floor}ì¸µ</b>ì— ë„ë‹¬í–ˆë‹¤.`);
					} else {
						log('ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì•˜ë‹¤.');
					}
					draw();
					presentExplore();
					syncHUD();
					renderStats();
				}
			}

			function chestEvent(){
				game.state='event';
				log('ìˆ˜ìƒí•œ <b>ë³´ë¬¼ìƒì</b>ë¥¼ ë°œê²¬í–ˆë‹¤. ì—´ì–´ë³¼ê¹Œ?');
				setChoices([
					{label:'ì—´ì–´ë³¸ë‹¤', class:'primary', run: ()=>{
						const roll = rand();
						if(roll < 0.58){
							const g = rndInt(6,14) + Math.floor(game.floor*1.4);
							game.player.gold += g;
							if(game.stats){ game.stats.goldEarned += g; game.stats.chestsOpened++; }
							log(`ìƒì ì•ˆì—ì„œ <span class="gold">${g}G</span>ë¥¼ ë°œê²¬í–ˆë‹¤!`);
							if(rand()<0.6){ const it = randomItem(); addItem(it); log(`ë˜ ë‹¤ë¥¸ ì „ë¦¬í’ˆ <span class="good">${it.name}</span>!`); }
							questProgress('chest');
							presentExplore(); syncHUD(); draw();
							renderStats();
						} else if(roll < 0.78){
							const dmg = rndInt(5,11) + Math.floor(game.floor*1.1);
							hurtPlayer(dmg);
							if(game.stats){ game.stats.chestsTrapped++; }
							log(`<span class="bad">í•¨ì •!</span> ë…ì¹¨ì´ ë‚ ì•„ì™”ë‹¤. ${dmg} í”¼í•´.`);
							if(checkGameOver()) return; presentExplore(); syncHUD(); draw();
							renderStats();
						} else {
							log('ìƒìê°€ ìœ¼ë¥´ë ê±°ë¦°ë‹¤... ë¯¸ë¯¹ì´ì—ˆë‹¤!');
							if(game.stats){ game.stats.mimicsEncountered++; }
							startCombat(spawnBoss('ë¯¸ë¯¹'));
						}
					}},
					{label:'ê·¸ëƒ¥ ì§€ë‚˜ì¹œë‹¤', run: ()=>{ log('ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ìƒìë¥¼ ì§€ë‚˜ì³¤ë‹¤.'); presentExplore(); draw(); }}
				]);
			}

			function rest(){
				const p = game.player;
				const heal = Math.max(2, Math.floor(p.maxHp*0.07));
				p.hp = clamp(p.hp + heal, 0, p.maxHp);
				log(`ì ì‹œ ìˆ¨ì„ ê³ ë¥¸ë‹¤. <span class="good">ì²´ë ¥ +${heal}</span>`);
				// ë§¤ë³µ í™•ë¥ 
				if(rand() < 0.25){
					log('ê·¸ëŸ¬ë‚˜ ë§¤ë³µì„ ë‹¹í–ˆë‹¤!');
					startCombat(spawnMonster());
				} else {
					presentExplore();
					draw();
					syncHUD();
				}
			}

			function itemValue(it){
				if(it.kind==='potion') return Math.max(4, Math.floor(it.heal*0.6));
				if(it.kind==='bomb') return Math.max(6, Math.floor(it.dmg*0.55));
				if(it.kind==='weapon') return 8 + it.atk*4 + (it.mods?6:0);
				if(it.kind==='armor') return 8 + it.def*4 + (it.mods?6:0);
				return 1;
			}

			function shopEvent(){
				game.state='event';
				// ìƒì  ì¬ê³  3ê°œ ìƒì„±
				const stock = [randomShopItem(), randomShopItem(), randomItem()].map(x=>({it:x, price: Math.max(6, Math.floor(itemValue(x)*1.2))}));
				log('ì–´ë‘ìš´ ë³µë„ ì˜†, ì‘ì€ <b>ìƒì </b>ì„ ë°œê²¬í–ˆë‹¤.');
				const drawShop = ()=>{
					const opts=[];
					stock.forEach((s,i)=>{
						if(!s) return; opts.push({
							label:`êµ¬ë§¤: ${s.it.name} - ${s.price}G`, class:'green',
							run: ()=>{
								if(game.player.gold < s.price){ log('ê³¨ë“œê°€ ë¶€ì¡±í•˜ë‹¤.'); return; }
								game.player.gold -= s.price; if(game.stats) game.stats.goldSpent += s.price; addItem(s.it); stock[i]=null; syncHUD(); renderStats(); drawShop();
							}
						});
					});
					// íŒë§¤ í•­ëª© ì¶”ê°€
					game.player.inventory.forEach((it,idx)=>{
						const val = Math.max(1, Math.floor(itemValue(it)*0.7));
						opts.push({
							label:`íŒë§¤: ${it.name}${it.amount>1?` x${it.amount}`:''} +${val}G`, class:'warn',
							run: ()=>{
								// ìŠ¤íƒ ì²˜ë¦¬: í•œ ê°œë§Œ íŒë§¤
								if(it.amount && it.amount>1){ it.amount--; } else { game.player.inventory.splice(idx,1); }
								game.player.gold += val; if(game.stats) game.stats.goldEarned += val;
								syncHUD(); renderStats(); drawShop();
							}
						});
					});
					opts.push({label:'ë– ë‚œë‹¤', run: ()=>{ log('ìƒì ì„ ë– ë‚¬ë‹¤.'); presentExplore(); draw(); }});
					setChoices(opts);
				};
				drawShop();
			}

			function startCombat(mon){
				game.state='combat';
				game.encounter = { monster: mon, turn: 'player'};
				log(`<b>${mon.name}${mon.level?` (Lv ${mon.level})`:''}</b> ì´(ê°€) ë‚˜íƒ€ë‚¬ë‹¤!`);
				draw();
				tickCooldowns();
				setChoices(playerOptions());
				syncHUD();
			}

			function tickCooldowns(){
				if(!game.skills) return;
				Object.values(game.skills).forEach(s=>{ if(s.cd>0) s.cd--; });
			}
			function playerOptions(){
				const s = game.skills || {powerStrike:{cd:0}, guardStance:{cd:0}, doubleSlash:{cd:0}, firstAid:{cd:0}};
				const psLabel = s.powerStrike.cd>0? `íŒŒì›Œ ìŠ¤íŠ¸ë¼ì´í¬ (ëŒ€ê¸° ${s.powerStrike.cd})` : 'íŒŒì›Œ ìŠ¤íŠ¸ë¼ì´í¬';
				const gsLabel = s.guardStance.cd>0? `ê°€ë“œ ìŠ¤íƒ ìŠ¤ (ëŒ€ê¸° ${s.guardStance.cd})` : 'ê°€ë“œ ìŠ¤íƒ ìŠ¤';
				const dsLabel = s.doubleSlash.cd>0? `ì—°ì† ë² ê¸° (ëŒ€ê¸° ${s.doubleSlash.cd})` : 'ì—°ì† ë² ê¸°';
				const faLabel = s.firstAid.cd>0? `ì‘ê¸‰ì¹˜ë£Œ (ëŒ€ê¸° ${s.firstAid.cd})` : 'ì‘ê¸‰ì¹˜ë£Œ';
				return [
					{label:'ê³µê²©í•œë‹¤', class:'primary', run: attack},
					{label:psLabel, run: ()=>{
						if(s.powerStrike.cd>0){ log('ì•„ì§ ìŠ¤í‚¬ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ë‹¤.'); return; }
						skillPowerStrike();
					}},
					{label:gsLabel, run: ()=>{
						if(s.guardStance.cd>0){ log('ì•„ì§ ìŠ¤í‚¬ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ë‹¤.'); return; }
						skillGuardStance();
					}},
					{label:dsLabel, run: ()=>{
						if(s.doubleSlash.cd>0){ log('ì•„ì§ ìŠ¤í‚¬ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ë‹¤.'); return; }
						skillDoubleSlash();
					}},
					{label:faLabel, run: ()=>{
						if(s.firstAid.cd>0){ log('ì•„ì§ ìŠ¤í‚¬ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ë‹¤.'); return; }
						skillFirstAid();
					}},
					{label:'ë°©ì–´í•œë‹¤', run: defend},
					{label:'ì•„ì´í…œ ì‚¬ìš©', run: openItems},
					{label:'ë„ë§ì¹œë‹¤', class:'warn', run: flee},
				];
			}

			function skillDoubleSlash(){
				const p=game.player; const m=game.encounter.monster; const s=game.skills;
				const base = getAtk(p);
				const effDef = Math.round(m.def * BAL.monster.defMitigationVsMonster);
				// ë‘ ë²ˆ íƒ€ê²©: ê° 70% ê³„ìˆ˜, ìµœì†Œ 1 ê³ ì •
				let hit1 = Math.max(1, Math.round((base - effDef + rndInt(BAL.combat.pVarMin, BAL.combat.pVarMax)) * 0.7));
				let hit2 = Math.max(1, Math.round((base - effDef + rndInt(BAL.combat.pVarMin, BAL.combat.pVarMax)) * 0.7));
				let total = hit1 + hit2;
				m.hp = Math.max(0, m.hp - total);
				log(`<b>ìŠ¤í‚¬!</b> ì—°ì† ë² ê¸°: <span class="good">${hit1}</span> + <span class="good">${hit2}</span> = <span class="good">${total}</span> í”¼í•´`);
				s.doubleSlash.cd = 3;
				if(m.hp<=0){ winCombat(); return; }
				enemyTurn();
				draw(); syncHUD();
			}

			function skillFirstAid(){
				const p=game.player; const s=game.skills;
				const heal = Math.max(6, Math.round(p.maxHp*0.18));
				healPlayer(heal);
				flashHP(`â¤ï¸ +${heal}`);
				log(`<b>ìŠ¤í‚¬!</b> ì‘ê¸‰ì¹˜ë£Œ: <span class="good">${heal} íšŒë³µ</span>`);
				s.firstAid.cd = 4;
				// ì¹˜ìœ  í›„ ì  í„´ ì§„í–‰
				enemyTurn(0.9); // ì•½ê°„ì˜ ë°©ì–´ ì´ì 
				draw(); syncHUD();
			}

			function skillPowerStrike(){
				const p=game.player; const m=game.encounter.monster; const s=game.skills;
				const base = getAtk(p);
				const effDef = Math.round(m.def * BAL.monster.defMitigationVsMonster);
				let dmg = Math.max(2, Math.round(base*1.5) - effDef + rndInt(0,1));
				m.hp = Math.max(0, m.hp - dmg);
				log(`<b>ìŠ¤í‚¬!</b> íŒŒì›Œ ìŠ¤íŠ¸ë¼ì´í¬ë¡œ ${m.name}ì—ê²Œ <span class="good">${dmg} í”¼í•´</span>`);
				s.powerStrike.cd = 3;
				if(m.hp<=0){ winCombat(); return; }
				enemyTurn();
				draw(); syncHUD();
			}
			function skillGuardStance(){
				const p=game.player; const s=game.skills; game.buffs = game.buffs||{};
				const heal = Math.max(1, Math.ceil(p.maxHp*0.05)); healPlayer(heal);
				game.buffs.guardTurns = (game.buffs.guardTurns||0) + 1;
				log(`<b>ìŠ¤í‚¬!</b> ê°€ë“œ ìŠ¤íƒ ìŠ¤: ë‹¤ìŒ ì  ê³µê²© í”¼í•´ ê°ì†Œ, <span class="good">+${heal} íšŒë³µ</span>`);
				s.guardStance.cd = 3;
				enemyTurn(1);
				draw(); syncHUD();
			}

			function getAtk(p){ return p.atk + (p.weapon?.atk||0); }
			function getDef(p){ return p.def + (p.armor?.def||0); }

			function applyRegen(){
				const p = game.player;
				const regen = (p.armor?.mods?.regen||0) + (p.weapon?.mods?.regen||0);
				if(regen>0){
					healPlayer(regen); log(`<span class="good">ì¬ìƒ +${regen}</span>`);
				}
			}

			function attack(){
				const p = game.player; const m = game.encounter.monster;
				applyRegen();
				const base = getAtk(p);
				const wtype = p.weapon?.wtype || 'sword';
				let effDef = Math.round(m.def * BAL.monster.defMitigationVsMonster);
				// ë¬´ê¸° íƒ€ì…: ë°©ì–´ ê´€í†µ ë“±
				if(wtype==='spear'){
					// ì°½: ì  ë°©ì–´ì˜ 35% ë¬´ì‹œ
					effDef = Math.max(0, Math.round(effDef * 0.65));
				}
				let varMin=BAL.combat.pVarMin, varMax=BAL.combat.pVarMax;
				if(wtype==='bow'){
					// í™œ: ë³€ë™ í­ ì¦ê°€
					varMin -= 1; varMax += 2;
				}
				let dmg = Math.max(1, base - effDef + rndInt(varMin, varMax));
				// ì¹˜ëª… ì„¤ì •: ë‹¨ê²€ í™•ë¥ â†‘, ë„ë¼ ë°°ìˆ˜â†‘, ë‹¨ê²€ ë°°ìˆ˜â†“
				let cChance = BAL.combat.critChance; let cMul = BAL.combat.critMul;
				if(wtype==='dagger'){ cChance += 0.08; cMul = Math.max(1.8, cMul-0.3); }
				if(wtype==='axe'){ cChance -= 0.02; cMul = cMul + 0.4; }
				if(rand() < cChance) { dmg=Math.round(dmg*cMul); log('<b>ì¹˜ëª…íƒ€!</b>'); }
				// ì§€íŒ¡ì´: ë§ˆë ¥ ì¶”ê°€ ê³ ì • í”¼í•´
				if(wtype==='staff'){ dmg += 2 + Math.floor(game.floor*0.2); }
				m.hp = Math.max(0, m.hp - dmg);
				log(`ë‹¹ì‹ ì€ ${m.name}ì„(ë¥¼) ê³µê²©í–ˆë‹¤. <span class="good">${dmg} í”¼í•´</span>`);
				// ìƒëª…í¡ìˆ˜
				const ls = (p.weapon?.mods?.lifesteal||0);
				if(ls>0 && dmg>0){ const heal = Math.max(1, Math.floor(dmg*ls)); healPlayer(heal); log(`âœ¨ ìƒëª…í¡ìˆ˜ <span class="good">+${heal}</span>`); }
				// ì¶œí˜ˆ: ë‹¤ìŒ ì  í„´ì— ì¶”ê°€ í”¼í•´(ê°„ë‹¨íˆ ì¦‰ì‹œ ì ìš©)
				if(p.weapon?.mods?.bleed && rand()<p.weapon.mods.bleed){ const b = Math.max(1, Math.floor(base*BAL.mods.bleed)); m.hp = Math.max(0, m.hp - b); log(`âœ¨ ì¶œí˜ˆ ì¶”ê°€ í”¼í•´ <span class="good">${b}</span>`); }
				// ê¸°ì ˆ: ì  í„´ ìŠ¤í‚µ
				let stunned = false; if(p.weapon?.mods?.stun && rand()<p.weapon.mods.stun){ stunned=true; log('âœ¨ ì ì´ <b>ê¸°ì ˆ</b>í–ˆë‹¤!'); }
				if(m.hp<=0){
					winCombat(); return;
				}
				// í™œ: íšŒí”¼ ë¬´ì‹œ ì†Œí­(ì  íšŒí”¼ëŠ” í˜„ì¬ ì—†ì§€ë§Œ, ê°€ë“œ íš¨ê³¼ ê²½ê° ì¡°ê¸ˆ ë¬´ì‹œ)
				if(!stunned) enemyTurn(); else { tickCooldowns(); setChoices(playerOptions()); draw(); }
				draw();
				syncHUD();
			}

			function defend(){
				log('ìì„¸ë¥¼ ë‚®ì¶° ë°©ì–´ì— ì§‘ì¤‘í•œë‹¤.');
				enemyTurn(0.5); // í”¼í•´ ì ˆë°˜
				draw();
				syncHUD();
			}

			function flee(){
				const m = game.encounter.monster;
				const chance = 0.55 + Math.max(0, (game.player.level-1)*0.03);
				if(rand() < chance){
					log(`${m.name}ì—ê²Œì„œ ë©€ì°ì´ ë„ë§ì³¤ë‹¤.`);
					game.encounter = null; presentExplore(); draw();
				} else {
					log('ë„ë§ì— ì‹¤íŒ¨í–ˆë‹¤!');
					enemyTurn(1);
					draw();
				}
				syncHUD();
			}

			function enemyTurn(scale=1){
				const p = game.player; const m = game.encounter.monster;
				applyRegen();
				// íšŒí”¼ íŒë‹¨
				const dodge = (p.armor?.mods?.dodge||0);
				const base = m.atk; const effDef = Math.round(getDef(p) * BAL.monster.defMitigationVsPlayer);
				let dmg = Math.max(1, base - effDef + rndInt(BAL.combat.eVarMin, BAL.combat.eVarMax));
				dmg = Math.round(dmg * scale);
				// ê°€ë“œ ìŠ¤íƒ ìŠ¤ í”¼í•´ ê°ì†Œ
				if((game.buffs?.guardTurns||0) > 0){ dmg = Math.round(dmg*BAL.combat.guardReduction); game.buffs.guardTurns = Math.max(0, game.buffs.guardTurns-1); }
				if(dodge>0 && rand()<dodge){
					log('âœ¨ ë‹¹ì‹ ì€ ì¬ë¹ ë¥´ê²Œ <b>íšŒí”¼</b>í–ˆë‹¤!');
				} else {
					hurtPlayer(dmg);
					log(`${m.name} ì˜ ê³µê²©! <span class="bad">${dmg} í”¼í•´</span>`);
					// ê°€ì‹œ ë°˜ê²©
					const th = (p.armor?.mods?.thorns||0);
					if(th>0){ m.hp = Math.max(0, m.hp - th); log(`âœ¨ ê°€ì‹œ ë°˜ê²© <span class="good">${th}</span>`); if(m.hp<=0){ winCombat(); return; } }
				}
				if(checkGameOver()) return;
				// ë‹¤ìŒ ì„ íƒì§€ ìœ ì§€
				tickCooldowns();
				setChoices(playerOptions());
			}

			function winCombat(){
				const m = game.encounter.monster; game.encounter=null;
				const gold = m.gold; const xp = m.xp;
				game.player.gold += gold;
				if(game.stats){ game.stats.goldEarned += gold; if(m.boss) game.stats.bossesDefeated++; else game.stats.monstersDefeated++; }
				// í€˜ìŠ¤íŠ¸: ì²˜ì¹˜ ì¹´ìš´íŠ¸ ì§„í–‰
				questProgress('slay');
				gainXP(xp);
				log(`ì „íˆ¬ì—ì„œ ìŠ¹ë¦¬í–ˆë‹¤! <span class="gold">+${gold}G</span>, ê²½í—˜ì¹˜ <span class="good">+${xp}</span>`);
				// ë“œë ì•„ì´í…œ í™•ë¥ 
				if(m.boss){
					// ì „ì„¤ ë¬´ê¸° 1ê°œ ë³´ì¥, ì „ì„¤ ë°©ì–´êµ¬ 30% í™•ë¥ 
					const lw = createWeapon(pickTierByFloor(game.floor), {key:'legendary',label:'ì „ì„¤',mul:1.25}, game.floor);
					addItem(lw); log(`ë³´ìŠ¤ ì²˜ì¹˜! <span class="good">${lw.name}</span> íšë“.`);
					if(rand()<0.30){ const la = createArmor(pickTierByFloor(game.floor), {key:'legendary',label:'ì „ì„¤',mul:1.25}, game.floor); addItem(la); log(`ì „ì„¤ ë°©ì–´êµ¬ ë³´ë„ˆìŠ¤! <span class="good">${la.name}</span> íšë“.`); }
					// ì¶”ê°€ ì¼ë°˜ ì „ë¦¬í’ˆ ì†Œí­
					if(rand()<0.4){ const it = randomItem(); addItem(it); log(`ì¶”ê°€ ì „ë¦¬í’ˆ: <span class="good">${it.name}</span>`); }
				} else if(rand()<0.35){
					const it = randomItem(); addItem(it); log(`ì „ë¦¬í’ˆìœ¼ë¡œ <span class="good">${it.name}</span> ì„(ë¥¼) ì–»ì—ˆë‹¤.`);
				}
				presentExplore(); draw(); syncHUD(); renderStats();
			}

			function gainXP(x){
				const p=game.player; p.xp += x;
				while(p.xp >= p.xpToNext){ p.xp -= p.xpToNext; levelUp(); }
			}
			function levelUp(){
				const p=game.player; p.level++;
							const hpGain = rndInt(BAL.player.hpGainMin, BAL.player.hpGainMax); p.maxHp += hpGain;
				const heal = Math.max(4, Math.floor(p.maxHp * 0.2));
				p.hp = clamp(p.hp + heal, 0, p.maxHp);
							p.atk += rndInt(BAL.player.atkPerLevelMin, BAL.player.atkPerLevelMax); p.def += (rand()<BAL.player.defUpChance?1:0);
							p.xpToNext = Math.round(p.xpToNext * BAL.player.xpGrowth);
				log(`<b>ë ˆë²¨ ì—…!</b> ì´ì œ Lv ${p.level}. ìµœëŒ€ ì²´ë ¥ +${hpGain}, ì¦‰ì‹œ íšŒë³µ +${heal}. ëŠ¥ë ¥ í–¥ìƒ.`);
			}

			function hurtPlayer(dmg){
				const p=game.player; p.hp = Math.max(0, p.hp - dmg);
			}
			function healPlayer(h){ const p=game.player; p.hp = clamp(p.hp + h, 0, p.maxHp); }
			function checkGameOver(){
				const p=game.player; if(p.hp<=0){
					game.state='gameover';
					if(game.stats){ game.stats.deaths++; }
					log(`<span class="bad"><b>ë‹¹ì‹ ì€ ì“°ëŸ¬ì¡Œë‹¤...</b></span>`);
					setChoices([
						{label:'ìƒˆ ê²Œì„', class:'primary', run: ()=> newGame() },
						{label:'ë¶ˆëŸ¬ì˜¤ê¸°', run: ()=> document.getElementById('loadBtn').click() },
					]);
					draw(); syncHUD();
					renderStats();
					return true;
				}
				return false;
			}

			// ===== ì•„ì´í…œ =====
			function itemDesc(it){
				switch(it.kind){
					case 'potion': return `ì‚¬ìš© ì‹œ ì²´ë ¥ +${it.heal}`;
					case 'weapon': return `ì¥ì°© ì‹œ ê³µê²© +${it.atk}${it.mods?modText(it.mods):''}`;
					case 'armor': return `ì¥ì°© ì‹œ ë°©ì–´ +${it.def}${it.mods?modText(it.mods):''}`;
					case 'bomb': return `ì „íˆ¬ ì¤‘ ì‚¬ìš© ì‹œ í° í”¼í•´ (${it.dmg})`;
				}
				return '';
			}

			// === íŠ¹ìˆ˜ ê¸°ëŠ¥(mod) ì²˜ë¦¬ ===
			// mods ì˜ˆ: { lifesteal:0.1, bleed:0.2, stun:0.1 } ë°±ë¶„ìœ¨ì€ í™•ë¥ /ë¹„ìœ¨
			function modText(mods){
				const parts=[];
				if(mods.lifesteal) parts.push(` Â· âœ¨ ìƒëª…í¡ìˆ˜ ${Math.round(mods.lifesteal*100)}%`);
				if(mods.bleed) parts.push(` Â· âœ¨ ì¶œí˜ˆ ${Math.round(mods.bleed*100)}%`);
				if(mods.stun) parts.push(` Â· âœ¨ ê¸°ì ˆ ${Math.round(mods.stun*100)}%`);
				if(mods.dodge) parts.push(` Â· âœ¨ íšŒí”¼ ${Math.round(mods.dodge*100)}%`);
				if(mods.thorns) parts.push(` Â· âœ¨ ê°€ì‹œ ${mods.thorns} ë°˜ê²©`);
				if(mods.regen) parts.push(` Â· âœ¨ ì¬ìƒ +${mods.regen}/í„´`);
				return parts.join('');
			}

			function randomItem(){
				const r = rand(); const f=game?.floor||1;
							if(r < 0.4){ return {id:uid(), name:'ì²´ë ¥ ë¬¼ì•½', kind:'potion', heal: rndInt(BAL.items.potionBase[0], BAL.items.potionBase[1]) + Math.floor(f*BAL.items.potionPerFloor), amount:1}; }
							if(r < 0.55){ return {id:uid(), name:'í­íƒ„', kind:'bomb', dmg: rndInt(BAL.items.bombBase[0], BAL.items.bombBase[1]) + Math.floor(f*BAL.items.bombPerFloor), amount:1}; }
				if(r < 0.78){
								return createWeapon(null, null, f);
				}
							return createArmor(null, null, f);
			}

			function randomShopItem(){
							const r = rand();
							if(r<0.5) return {id:uid(), name:'ì²´ë ¥ ë¬¼ì•½', kind:'potion', heal:rndInt(12,20)+Math.floor(game.floor*BAL.items.potionPerFloor*1.1), amount:1};
							if(r<0.75) return createWeapon(null, pickRarity({shop:true}), game.floor);
							return createArmor(null, pickRarity({shop:true}), game.floor);
			}

			function maybeModWeapon(w, chance){
							const c = chance ?? (0.22 + Math.min(0.13, (game.floor-1)*0.015));
							if(rand()<c){
								const roll = rand(); w.mods = w.mods||{};
								if(roll<0.33){ w.mods.lifesteal = BAL.mods.lifesteal; w.name = 'í¡í˜ˆ ' + w.name; }
								else if(roll<0.66){ w.mods.bleed = BAL.mods.bleed; w.name = 'ë‚ ì¹´ë¡œìš´ ' + w.name; }
								else { w.mods.stun = BAL.mods.stun; w.name = 'ì¶©ê²©ì˜ ' + w.name; }
							}
							// ë‚®ì€ í™•ë¥ ë¡œ ì¬ìƒ ë¶€ì—¬
							if(rand()<BAL.mods.regenChance){ w.mods = w.mods||{}; w.mods.regen = 1; w.name = 'ì¬ìƒì˜ ' + w.name; }
							return w;
			}
			function maybeModArmor(a, chance){
							const c = chance ?? (0.22 + Math.min(0.13, (game.floor-1)*0.015));
							if(rand()<c){
								const roll = rand(); a.mods = a.mods||{};
								if(roll<0.45){ a.mods.dodge = BAL.mods.armorDodge; a.name = 'ë¯¼ì²©í•œ ' + a.name; }
								else { a.mods.thorns = BAL.mods.thornsBase + Math.floor(game.floor*BAL.mods.thornsPerFloor); a.name = 'ê°€ì‹œ ' + a.name; }
							}
							// ë‚®ì€ í™•ë¥ ë¡œ ì¬ìƒ ë¶€ì—¬
							if(rand()<BAL.mods.regenChance){ a.mods = a.mods||{}; a.mods.regen = 1; a.name = 'ì¬ìƒì˜ ' + a.name; }
							return a;
			}

			function uid(){ return Math.random().toString(36).slice(2) + (Date.now()%1e6).toString(36); }

			function addItem(it){
				// ê°™ì€ ì†Œë¹„í…œì€ ìŠ¤íƒ
				if(it.kind==='potion' || it.kind==='bomb'){
					const found = game.player.inventory.find(x=>x.kind===it.kind && x.name===it.name && itemDesc(x)===itemDesc(it));
					if(found){ found.amount += it.amount; return; }
				}
				game.player.inventory.push(it);
				renderInventory();
			}

			function useItem(idx){
				const it = game.player.inventory[idx]; if(!it) return;
				if(it.kind==='potion'){
					healPlayer(it.heal);
					it.amount--; if(it.amount<=0) game.player.inventory.splice(idx,1);
					log(`<span class="good">${it.name}</span> ì‚¬ìš©! ì²´ë ¥ ${it.heal} íšŒë³µ.`);
					// HUD ì‹œê° íš¨ê³¼
					flashHP(`â¤ï¸ +${it.heal}`);
					if(game.stats){ game.stats.potionsUsed++; }
					syncHUD();
					renderStats();
					return;
				}
				if(it.kind==='bomb'){
					if(game.state!=='combat'){ log('í­íƒ„ì€ ì „íˆ¬ ì¤‘ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.'); return; }
					const m=game.encounter.monster; m.hp = Math.max(0, m.hp - it.dmg);
					it.amount--; if(it.amount<=0) game.player.inventory.splice(idx,1);
					log(`<b>í­íƒ„!</b> ${m.name} ì—ê²Œ <span class="good">${it.dmg} í”¼í•´</span>`);
					if(game.stats){ game.stats.bombsUsed++; }
					if(m.hp<=0){ winCombat(); } else { enemyTurn(); draw(); syncHUD(); }
					return;
				}
				if(it.kind==='weapon'){
					const old = game.player.weapon; game.player.weapon = it; game.player.inventory.splice(idx,1);
					if(old) { game.player.inventory.push(old); }
					const wt = WEAPON_TYPES.find(w=>w.key===it.wtype);
					log(`${wt?.emoji||'âš”ï¸'} <b>${it.name}</b> ì¥ì°©. (ê³µê²© +${it.atk})`);
					floatPop(document.getElementById('atkWrap'), `âš”ï¸ +${it.atk}`, 'buff');
					syncHUD();
					return;
				}
				if(it.kind==='armor'){
					const old = game.player.armor; game.player.armor = it; game.player.inventory.splice(idx,1);
					if(old) { game.player.inventory.push(old); }
					log(`<b>${it.name}</b> ì¥ì°©. (ë°©ì–´ +${it.def})`);
					floatPop(document.getElementById('defWrap'), `ğŸ›¡ï¸ +${it.def}`, 'buff');
					syncHUD();
					return;
				}
			}

			function flashHP(text){
				const bar = document.getElementById('hpbar');
				bar.classList.remove('pulse'); // restart animation
				void bar.offsetWidth;
				bar.classList.add('pulse');
				floatPop(bar, text, 'heal');
			}
			function floatPop(anchorEl, text, cls){
				if(!anchorEl) return;
				const host = document.getElementById('screen-wrap');
				const r1 = anchorEl.getBoundingClientRect();
				const r2 = host.getBoundingClientRect();
				const x = r1.left + r1.width/2 - r2.left;
				const y = r1.top - r2.top;
				const el = document.createElement('div');
				el.className = `float-pop ${cls||''}`;
				el.textContent = text;
				el.style.left = `${x}px`;
				el.style.top = `${y}px`;
				host.appendChild(el);
				setTimeout(()=> el.remove(), 1000);
			}

			function openItems(){
				const p = game.player;
				if(p.inventory.length===0){ log('ì‚¬ìš©í•  ì•„ì´í…œì´ ì—†ë‹¤.'); return; }
				// ì¸ë²¤í† ë¦¬ ì˜ì—­ì˜ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ë„ë¡ ì•ˆë‚´
				log('ì‚¬ìš©í•  ì•„ì´í…œì„ ì¸ë²¤í† ë¦¬ì—ì„œ ì„ íƒí•˜ì„¸ìš”.');
			}

			// ===== ì„ íƒì§€ UI =====
			const choicesEl = document.getElementById('choices');
			function setChoices(items){
				choicesEl.innerHTML = '';
				game.lastChoices = items;
				items.forEach((it, i)=>{
					const btn = document.createElement('button');
					btn.className = 'btn ' + (it.class||'');
					btn.setAttribute('data-idx', i);
					btn.innerHTML = `<b>${i+1}.</b> ${it.label}`;
					btn.onclick = ()=> it.run();
					choicesEl.appendChild(btn);
				});
				if(items.length===0){
					const info=document.createElement('div'); info.style.color='var(--muted)'; info.textContent='ì„ íƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'; choicesEl.appendChild(info);
				}
			}

			window.addEventListener('keydown', (e)=>{
				if(e.key>='1' && e.key<='9'){
					const idx = Number(e.key)-1; const ch=game.lastChoices[idx]; if(ch){ ch.run(); e.preventDefault(); }
				} else if(e.key==='ArrowUp'){
					if(game.state==='explore') move('forward');
				} else if(e.key==='ArrowLeft'){
					if(game.state==='explore') move('left');
				} else if(e.key==='ArrowRight'){
					if(game.state==='explore') move('right');
				} else if(e.key==='r' || e.key==='R'){
					requestNewGame();
				} else if(e.key==='s' || e.key==='S'){
						saveGame();
				} else if(e.key==='l' || e.key==='L'){
					document.getElementById('loadBtn').click();
				} else if(e.key==='t' || e.key==='T'){
					openStats();
				} else if(e.key==='Escape'){
					closeStats();
				}
			});

			// ì§„í–‰ í™•ì¸ ë° ìƒˆ ê²Œì„ ìš”ì²­
			function hasProgress(){
				try{
					if(!game) return false;
					if(game.state === 'gameover') return false;
					const p = game.player || {};
					if(game.steps && game.steps>0) return true;
					if(game.floor && game.floor>1) return true;
					if(p.level && p.level>1) return true;
					if(p.xp && p.xp>0) return true;
					if(Array.isArray(p.inventory) && p.inventory.length>0) return true;
					if(p.weapon || p.armor) return true;
					if(typeof p.gold === 'number' && p.gold !== 30) return true;
					return false;
				}catch(_){ return true; }
			}

			function requestNewGame(){
				if(hasProgress()){
					const ok = window.confirm('ì •ë§ ìƒˆ ê²Œì„ì„ ì‹œì‘í• ê¹Œìš”? í˜„ì¬ ì§„í–‰ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.');
					if(!ok) return;
				}
				newGame();
			}

			// ===== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
			function serialize(){
				const snapshot = JSON.stringify({
					version: V,
					savedAt: new Date().toISOString(),
					game
				}, null, 2);
				return snapshot;
			}

			function saveGame(){
				const data = serialize();
				const saveAs = (filename)=>{
					const blob = new Blob([data], {type:'application/json'});
					const a = document.createElement('a');
					a.href = URL.createObjectURL(blob);
					a.download = filename;
					document.body.appendChild(a); a.click(); a.remove();
					setTimeout(()=> URL.revokeObjectURL(a.href), 5000);
				};
				const ts = nowStr();
				// í•­ìƒ .rpgë¡œ ì €ì¥
				saveAs(`dungeon-save-${ts}.rpg`);
				log('ì§„í–‰ ìƒí™©ì„ ì €ì¥í–ˆë‹¤.');
			}

			function loadGameFromText(text){
				try{
					const data = JSON.parse(text);
					if(!data || typeof data !== 'object' || !data.game){ throw new Error('í˜•ì‹ ì˜¤ë¥˜'); }
					if(data.version!==V && data.game?.version!==V){ log('ê²½ê³ : ë‹¤ë¥¸ ë²„ì „ì˜ ì €ì¥ íŒŒì¼ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); }
					game = data.game;
					// ì—­ì§ë ¬í™” ì‹œ ë°©ì–´ ì½”ë“œ
					if(!game.player) game.player = basePlayer();
					if(typeof game.rngState !== 'number') game.rngState = Date.now()>>>0;
					if(!game.stats) game.stats = baseStats(); // í•˜ìœ„í˜¸í™˜: êµ¬ë²„ì „ ì €ì¥ì—” stats ì—†ìŒ
					if(!game.buffs) game.buffs = { blessing: 0 };
					if(!game.skills) game.skills = { powerStrike:{cd:0}, guardStance:{cd:0}, doubleSlash:{cd:0}, firstAid:{cd:0} };
					// ëˆ„ë½ëœ ì‹ ê·œ ìŠ¤í‚¬ í‚¤ ë³´ê°•
					game.skills.powerStrike ??= {cd:0};
					game.skills.guardStance ??= {cd:0};
					game.skills.doubleSlash ??= {cd:0};
					game.skills.firstAid ??= {cd:0};
					if(!game.quest) { ensureQuest(); } else { renderQuestLine?.(); }
					log('ì €ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ë‹¤. ëª¨í—˜ì„ ê³„ì†í•œë‹¤.');
					draw(); syncHUD(); renderStats();
					if(game.state==='combat' && game.encounter){
						// ìŠ¤í‚¬ í¬í•¨ ìµœì‹  ì„ íƒì§€ë¡œ ëŒ€ì²´
						setChoices(playerOptions());
					} else if(game.state==='gameover'){
						setChoices([
							{label:'ìƒˆ ê²Œì„', class:'primary', run: ()=> newGame() },
							{label:'ë¶ˆëŸ¬ì˜¤ê¸°', run: ()=> document.getElementById('loadBtn').click() },
						]);
					} else {
						presentExplore();
					}
				}catch(err){
					console.error(err);
					log('<span class="bad">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:</span> .rpg/.json ì €ì¥ íŒŒì¼ì´ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
				}
			}

			// ===== í”½ì…€ ë Œë”ë§ =====
			const canvas = document.getElementById('screen');
			const ctx = canvas.getContext('2d');

			function draw(){
				// ë°°ê²½ íƒ€ì¼ ë¬´ëŠ¬
				const w=canvas.width,h=canvas.height; ctx.imageSmoothingEnabled=false;
				ctx.fillStyle = '#0a0a14'; ctx.fillRect(0,0,w,h);
				for(let y=0;y<h;y+=8){
					for(let x=0;x<w;x+=8){
						const n = (x*13 + y*7 + game.floor*31) % 32;
						ctx.fillStyle = n<8? '#111629' : n<16? '#0f1324' : '#0c1020';
						ctx.fillRect(x,y,8,8);
					}
				}
				// ë°”ë‹¥ í•˜ì´ë¼ì´íŠ¸
				for(let y=0;y<h;y+=16){
					ctx.fillStyle = '#0b0f1e'; ctx.fillRect(0,y+12,w,2);
				}

				// í”Œë ˆì´ì–´ (ì¢Œì¸¡ ì¤‘ì•™)
				drawHero(40, h/2);

				if(game.state==='combat' && game.encounter){
					drawMonster(120, h/2, game.encounter.monster);
					const hbColor = game.encounter.monster.boss? '#ffb347' : '#ff5f75';
					drawHealthBar(92, 14, 60, game.encounter.monster.hp, game.encounter.monster.maxHp, hbColor);
				} else if(game.state==='event'){
					drawChest(120, h/2);
				} else if(game.state==='gameover'){
					drawSkull(w/2, h/2);
				} else {
					// í†µë¡œ ëŠë‚Œì˜ ì›ê·¼ì„ 
					ctx.strokeStyle='#1e2a44'; ctx.lineWidth=1; ctx.beginPath();
					for(let i=0;i<6;i++){
						const yy = 20+i*16; ctx.moveTo(20,yy); ctx.lineTo(w-20,yy);
					}
					ctx.stroke();
				}
			}

			function drawHero(cx, cy){
				ctx.save();
				ctx.translate(cx-6, cy-8);
				// ë§í† 
				ctx.fillStyle = '#2a87a5'; ctx.fillRect(4,3,6,8);
				// ëª¸í†µ
				ctx.fillStyle = '#f0f0f8'; ctx.fillRect(5,7,4,5);
				// ë¨¸ë¦¬
				ctx.fillStyle = '#e6c9a7'; ctx.fillRect(5,2,4,4);
				// ì¹¼
				ctx.fillStyle = '#cfcfd6'; ctx.fillRect(0,8,5,2);
				ctx.fillStyle = '#9c9cb2'; ctx.fillRect(0,7,1,4);
				ctx.restore();
			}
			function drawMonster(cx, cy, m){
				ctx.save(); ctx.translate(cx-8, cy-10);
				ctx.fillStyle = m.color || '#bada55';
				ctx.fillRect(2,4,12,12);
				ctx.fillStyle = '#000'; ctx.fillRect(4,8,3,3); ctx.fillRect(11,8,3,3);
				ctx.fillStyle = '#fff'; ctx.fillRect(5,9,1,1); ctx.fillRect(12,9,1,1);
				ctx.restore();
			}
			function drawHealthBar(x,y,w,hp,maxHp,color){
				ctx.fillStyle='#1a1a2e'; ctx.fillRect(x,y,w,6); ctx.fillStyle='#2e2e4d'; ctx.fillRect(x,y,w,6);
				const pct = clamp(hp/maxHp,0,1);
				ctx.fillStyle = color || '#ff5f75'; ctx.fillRect(x,y,Math.round(w*pct),6);
				// ìˆ«ì í‘œê¸° (hp/maxHp) - ë°” ì•„ë˜ì— ì‘ê²Œ í‘œì‹œ
				ctx.save();
				ctx.font = '8px monospace';
				ctx.textAlign = 'center';
				ctx.textBaseline = 'top';
				ctx.fillStyle = '#e8eef8';
				ctx.fillText(`${hp}/${maxHp}`, Math.round(x + w/2), y + 7);
				ctx.restore();
			}
			function drawChest(cx,cy){ ctx.save(); ctx.translate(cx-8,cy-6); ctx.fillStyle='#8b5a2b'; ctx.fillRect(0,4,16,10); ctx.fillStyle='#c7923f'; ctx.fillRect(0,4,16,2); ctx.fillStyle='#333'; ctx.fillRect(7,8,2,4); ctx.restore(); }
			function drawSkull(cx,cy){ ctx.save(); ctx.translate(cx-8,cy-8); ctx.fillStyle='#ddd'; ctx.fillRect(3,2,10,8); ctx.fillStyle='#000'; ctx.fillRect(5,5,2,2); ctx.fillRect(9,5,2,2); ctx.fillRect(7,9,2,2); ctx.restore(); }

			// ===== ë²„íŠ¼ ë°”ì¸ë”© =====
			document.getElementById('newGameBtn').addEventListener('click', ()=> requestNewGame());
			document.getElementById('saveBtn').addEventListener('click', ()=> saveGame());
			document.getElementById('loadBtn').addEventListener('click', ()=> document.getElementById('loadInput').click());
			document.getElementById('loadInput').addEventListener('change', (e)=>{
				const file = e.target.files?.[0]; if(!file) return;
				const reader = new FileReader(); reader.onload = ()=> loadGameFromText(String(reader.result)); reader.readAsText(file);
			});

			// ===== í†µê³„ ëª¨ë‹¬ =====
			function renderStats(){
				const s = game?.stats; if(!s) return;
				document.getElementById('st_monsters').textContent = String(s.monstersDefeated);
				document.getElementById('st_bosses').textContent = String(s.bossesDefeated);
				document.getElementById('st_deaths').textContent = String(s.deaths);
				document.getElementById('st_steps').textContent = String(s.stepsTaken);
				document.getElementById('st_maxfloor').textContent = String(s.maxFloor);
				document.getElementById('st_potions').textContent = String(s.potionsUsed);
				document.getElementById('st_bombs').textContent = String(s.bombsUsed);
				document.getElementById('st_goldEarned').textContent = String(s.goldEarned);
				document.getElementById('st_goldSpent').textContent = String(s.goldSpent);
				document.getElementById('st_chests').textContent = String(s.chestsOpened);
				document.getElementById('st_chestTrap').textContent = String(s.chestsTrapped);
				document.getElementById('st_mimic').textContent = String(s.mimicsEncountered);
			}

			function openStats(){ const m = document.getElementById('statsModal'); renderStats(); m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
			function closeStats(){ const m = document.getElementById('statsModal'); m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }

			document.getElementById('statsBtn').addEventListener('click', openStats);
			document.getElementById('statsCloseBtn').addEventListener('click', closeStats);
			document.getElementById('statsModal').addEventListener('click', (e)=>{ if(e.target.id==='statsModal') closeStats(); });

			// ===== ì‹œì‘ =====
			newGame();
		</script>
	</body>
	</html>

